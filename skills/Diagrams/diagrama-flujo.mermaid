---
config:
  layout: elk
---
flowchart TB
 subgraph ETL_Process["ğŸ”„ Proceso ETL"]
        ValidateAPI{"âœ… API<br>responde OK?"}
        Extract["1ï¸âƒ£ EXTRACT<br>ğŸŒ Conectar a GOV.CO API"]
        ErrorAPI["âŒ Error de conexiÃ³n"]
        ParseJSON["ğŸ“‹ Parsear JSON response"]
        Transform["2ï¸âƒ£ TRANSFORM<br>ğŸ”§ Limpiar y mapear datos"]
        ValidateData{"âœ… Datos<br>vÃ¡lidos?"}
        ErrorData["âŒ Error de validaciÃ³n"]
        MapToEntity["ğŸ—ºï¸ Mapear a TarifaElectrica"]
        Load["3ï¸âƒ£ LOAD<br>ğŸ’¾ Guardar en PostgreSQL"]
        BulkInsert["ğŸ“¦ Bulk Insert"]
        UpdateLog["âœï¸ Actualizar log<br>Estado: Success"]
  end
    Start(["ğŸš€ Inicio del Sistema"]) --> CheckDB{"Â¿Base de datos<br>tiene datos?"}
    CheckDB -- No --> AdminAccess["ğŸ‘¨â€ğŸ’¼ Admin accede a /admin"]
    CheckDB -- SÃ­ --> UserFlow["ğŸ‘¤ Usuario accede al sistema"]
    AdminAccess --> ClickETL@{ label: "ğŸ–±ï¸ Click en 'Ejecutar ETL'" }
    ClickETL --> StartETL["ğŸ“Š ETL Service inicia"]
    StartETL --> CreateLog["ğŸ“ Crear registro de log<br>Estado: Running"]
    CreateLog --> Extract
    Extract --> ValidateAPI
    ValidateAPI -- No --> ErrorAPI
    ValidateAPI -- SÃ­ --> ParseJSON
    ParseJSON --> Transform
    Transform --> ValidateData
    ValidateData -- No --> ErrorData
    ValidateData -- SÃ­ --> MapToEntity
    MapToEntity --> Load
    Load --> BulkInsert
    BulkInsert --> UpdateLog
    ErrorAPI --> LogError1["ğŸ“ Guardar log<br>Estado: Failed"]
    ErrorData --> LogError2["ğŸ“ Guardar log<br>Estado: Failed"]
    UpdateLog --> ShowSuccess@{ label: "âœ… Mostrar mensaje:<br>'ETL completado exitosamente'" }
    LogError1 --> ShowError["âŒ Mostrar error en UI"]
    LogError2 --> ShowError
    ShowSuccess --> UserFlow
    ShowError --> AdminRetry{"Â¿Reintentar?"}
    AdminRetry -- SÃ­ --> ClickETL
    AdminRetry -- No --> End1(["âŒ Fin - Sin datos"])
    UserFlow --> ChoosePage{"Usuario elige<br>pÃ¡gina"}
    ChoosePage -- ğŸ“„ Factura --> FacturaPage[/"factura"/]
    FacturaPage --> InputConsumo["âŒ¨ï¸ Usuario ingresa<br>consumo en kWh"]
    InputConsumo --> ClickCalc@{ label: "ğŸ–±ï¸ Click 'Calcular'" }
    ClickCalc --> CallAPI1["ğŸ“¡ GET /api/tarifas/actual"]
    CallAPI1 --> GetTarifa["ğŸ“Š Obtener tarifa actual<br>desde PostgreSQL"]
    GetTarifa --> Calculate["ğŸ§® Calcular factura:<br>consumo Ã— componentes"]
    Calculate --> ShowFactura["ğŸ“‹ Mostrar desglose:<br>- Compra energÃ­a<br>- Transporte<br>- DistribuciÃ³n<br>- Etc."]
    ShowFactura --> ShowTooltips["ğŸ’¡ Tooltips educativos<br>disponibles"]
    ShowTooltips --> UserDecision1{"Â¿QuÃ© hace<br>el usuario?"}
    UserDecision1 -- Nueva simulaciÃ³n --> InputConsumo
    UserDecision1 -- Ir a educaciÃ³n --> EducacionPage(["/educacion/"])
    UserDecision1 -- Salir --> End2(["âœ… Fin"])
    ChoosePage -- ğŸ“ EducaciÃ³n --> EducacionPage
    EducacionPage --> CallAPI2["ğŸ“¡ GET /api/tarifas/componentes"]
    CallAPI2 --> GetComponentes["ğŸ“š Obtener componentes<br>educativos desde DB"]
    GetComponentes --> RenderCards["ğŸ´ Renderizar cards:<br>- Icono<br>- Nombre<br>- DescripciÃ³n simple<br>- AnalogÃ­a"]
    RenderCards --> ShowAnalogy@{ label: "ğŸšš Mostrar secciÃ³n<br>'AnalogÃ­a del Delivery'" }
    ShowAnalogy --> UserDecision2{"Â¿QuÃ© hace<br>el usuario?"}
    UserDecision2 -- Ir a factura --> FacturaPage
    UserDecision2 -- Salir --> End2
    ChoosePage -- âš™ï¸ Admin --> AdminPage(["/admin/"])
    AdminPage --> ShowAdminPanel["ğŸ›ï¸ Mostrar panel:<br>- BotÃ³n ETL<br>- Tabla de logs"]
    ShowAdminPanel --> CallAPI3["ğŸ“¡ GET /api/etl/logs"]
    CallAPI3 --> GetLogs["ğŸ“œ Obtener histÃ³rico<br>de ejecuciones"]
    GetLogs --> ShowLogs["ğŸ“Š Tabla de logs:<br>- Fecha<br>- Estado<br>- Registros<br>- DuraciÃ³n"]
    ShowLogs --> AdminDecision{"Â¿QuÃ© hace<br>el admin?"}
    AdminDecision -- Ejecutar ETL --> ClickETL
    AdminDecision -- Ver detalles --> ShowDetails["ğŸ” Ver detalle de log"]
    AdminDecision -- Salir --> End2
    ShowDetails --> ShowLogs
    MonthlyUpdate(["ğŸ“… Nuevo mes"]) --> AdminNotified["ğŸ“§ Admin recibe<br>recordatorio mensual"]
    AdminNotified --> AdminAccess

    ClickETL@{ shape: rect}
    ShowSuccess@{ shape: rect}
    ClickCalc@{ shape: rect}
    ShowAnalogy@{ shape: rect}
    style Extract fill:#2196F3,stroke:#1976D2,stroke-width:2px,color:#fff
    style ErrorAPI fill:#f44336,stroke:#c62828,stroke-width:2px,color:#fff
    style Transform fill:#9C27B0,stroke:#7B1FA2,stroke-width:2px,color:#fff
    style ErrorData fill:#f44336,stroke:#c62828,stroke-width:2px,color:#fff
    style Load fill:#4CAF50,stroke:#388E3C,stroke-width:2px,color:#fff
    style Start fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    style ShowSuccess fill:#4CAF50,stroke:#2E7D32,stroke-width:2px,color:#fff
    style ShowError fill:#f44336,stroke:#c62828,stroke-width:2px,color:#fff
    style End1 fill:#f44336,stroke:#c62828,stroke-width:2px,color:#fff
    style FacturaPage fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    style EducacionPage fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    style End2 fill:#4CAF50,stroke:#2E7D32,stroke-width:2px,color:#fff
    style AdminPage fill:#FFF3E0,stroke:#F57C00,stroke-width:2px
    style MonthlyUpdate fill:#FF9800,stroke:#F57C00,stroke-width:2px,color:#fff
    style ETL_Process fill:#E8F5E9,stroke:#388E3C,stroke-width:3px