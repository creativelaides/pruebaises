---
config:
  layout: elk
---
flowchart TB
  Start(["ðŸš€ Inicio"]) --> Auth["ðŸ” Auth (Identity)"]
  Auth --> Token["ðŸŽŸï¸ Bearer Token"]

  Token --> TariffsFlow["ðŸ“Š Consultas de tarifas"]
  Token --> InvoiceFlow["ðŸ§¾ SimulaciÃ³n de factura"]
  Token --> EtlFlow["ðŸ”„ ETL (solo Admin)"]
  Token --> EmailFlow["âœ‰ï¸ Email test (solo Admin + Dev)"]

  subgraph TariffsFlow["ðŸ“Š Consultas de tarifas"]
    TariffLatest["GET /api/tariffs/latest"]
    TariffById["GET /api/tariffs/{id}"]
    TariffByPeriod["GET /api/tariffs/by-period"]
    TariffAll["GET /api/tariffs?page=1&pageSize=50"]
  end

  subgraph InvoiceFlow["ðŸ§¾ SimulaciÃ³n de factura"]
    InvoiceSim["POST /api/invoices/simulate"]
  end

  subgraph EtlFlow["ðŸ”„ ETL (Admin)"]
    EtlStart["POST /api/etl/run"]
    Extract["EXTRACT: Socrata API"]
    Transform["TRANSFORM: Map + Validate"]
    Load["LOAD: PostgreSQL (Docker local)"]
    EtlStart --> Extract --> Transform --> Load
  end

  subgraph EmailFlow["âœ‰ï¸ Email (Admin)"]
    EmailTest["POST /api/email/test?to=..."]
    EmailTest --> Smtp["SMTP Gmail"]
  end

  TariffLatest --> Db["PostgreSQL (Docker local)"]
  TariffById --> Db
  TariffByPeriod --> Db
  TariffAll --> Db
  InvoiceSim --> Db
  Load --> Db

  style Start fill:#4CAF50,stroke:#2E7D32,stroke-width:2px,color:#fff
  style Auth fill:#CE93D8,stroke:#7B1FA2,stroke-width:2px
  style Token fill:#BA68C8,stroke:#7B1FA2,stroke-width:2px,color:#fff
  style EtlStart fill:#FFB74D,stroke:#F57C00,stroke-width:2px
  style Load fill:#4CAF50,stroke:#388E3C,stroke-width:2px,color:#fff
  style Db fill:#FFE0B2,stroke:#F57C00,stroke-width:2px
