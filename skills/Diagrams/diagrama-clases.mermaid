---
config:
  layout: elk
---
classDiagram
direction RL
    class RootEntity {
        +Guid Id
        +DateTime CreatedAt
        +DateTime DateUpdated
    }

    class AuditableEntity {
        +string CreatedBy
        +string UpdatedBy
    }

    class Company {
        +string Code
        +UpdateCode(code)
    }

    class ElectricityTariff {
        +TariffPeriod Period
        +TariffCosts Costs
        +Guid CompanyId
        +UpdateCosts(costs)
        +SimulateInvoice(kwh)
    }

    class EtlLog {
        +DateTime ExecutionDate
        +EtlState State
        +int ProcessedRecords
        +string Message
        +decimal DurationSeconds
    }

    class TariffPeriod {
        +int Year
        +string Period
        +string Level
        +string TariffOperator
    }

    class TariffCosts {
        +decimal CuTotal
        +decimal CostoCompraG
        +decimal CargoTransporteStnTn
        +decimal CargoTransporteSdldn
        +decimal MargenComercializacion
        +decimal CostoPerdidas
        +decimal Restricciones
        +decimal Cot
        +decimal Cfm
        +CalculateTotal()
    }

    class InvoiceSimulation {
        +decimal Total
        +List~InvoiceComponent~ Components
    }

    class InvoiceComponent {
        +string Name
        +string Explanation
        +decimal Value
    }

    class IRepository~T~
    class IElectricityTariffRepository
    class ICompanyRepository
    class IEtlLogRepository
    class IUnitOfWork

    class TariffDbContext
    class UnitOfWorkEFCore

    class SocrataClient
    class SocrataEtlService

    class IEmailService
    class SmtpEmailService

    class IAppUserService
    class AppUserService
    class AppIdentityDbContext
    class AppUser
    class AppRole

    class CreateTariffCommandHandler
    class UpdateTariffCommandHandler
    class DeleteTariffCommandHandler
    class GetTariffByIdQueryHandler
    class GetTariffByPeriodQueryHandler
    class GetLatestTariffQueryHandler
    class GetAllTariffsQueryHandler
    class SimulateInvoiceQueryHandler

    class TariffsController
    class InvoicesController
    class EtlController
    class EmailController

    RootEntity <|-- AuditableEntity
    AuditableEntity <|-- Company
    AuditableEntity <|-- ElectricityTariff
    AuditableEntity <|-- EtlLog
    ElectricityTariff --> TariffPeriod
    ElectricityTariff --> TariffCosts
    InvoiceSimulation --> InvoiceComponent
    EtlLog --> EtlState

    IRepository~T~ <|.. IElectricityTariffRepository
    IRepository~T~ <|.. ICompanyRepository
    IRepository~T~ <|.. IEtlLogRepository

    IUnitOfWork --> IElectricityTariffRepository
    IUnitOfWork --> ICompanyRepository
    IUnitOfWork --> IEtlLogRepository

    UnitOfWorkEFCore ..|> IUnitOfWork
    UnitOfWorkEFCore --> TariffDbContext

    SocrataEtlService --> SocrataClient
    SocrataEtlService --> IUnitOfWork

    SmtpEmailService ..|> IEmailService
    AppUserService ..|> IAppUserService
    AppIdentityDbContext --> AppUser
    AppIdentityDbContext --> AppRole

    TariffsController --> CreateTariffCommandHandler
    TariffsController --> UpdateTariffCommandHandler
    TariffsController --> DeleteTariffCommandHandler
    TariffsController --> GetTariffByIdQueryHandler
    TariffsController --> GetTariffByPeriodQueryHandler
    TariffsController --> GetLatestTariffQueryHandler
    TariffsController --> GetAllTariffsQueryHandler
    InvoicesController --> SimulateInvoiceQueryHandler
    EtlController --> SocrataEtlService
    EmailController --> IEmailService

    style RootEntity fill:#e3f2fd
    style AuditableEntity fill:#e3f2fd
    style Company fill:#e3f2fd
    style ElectricityTariff fill:#e3f2fd
    style EtlLog fill:#e3f2fd
    style TariffPeriod fill:#f3e5f5
    style TariffCosts fill:#f3e5f5
    style InvoiceSimulation fill:#f3e5f5
    style InvoiceComponent fill:#f3e5f5
    style IRepository~T~ fill:#fff3e0
    style IElectricityTariffRepository fill:#fff3e0
    style ICompanyRepository fill:#fff3e0
    style IEtlLogRepository fill:#fff3e0
    style IUnitOfWork fill:#fff3e0
    style TariffDbContext fill:#e8f5e9
    style UnitOfWorkEFCore fill:#e8f5e9
    style SocrataClient fill:#e8f5e9
    style SocrataEtlService fill:#e8f5e9
    style AppIdentityDbContext fill:#e8f5e9
    style TariffsController fill:#fce4ec
    style InvoicesController fill:#fce4ec
    style EtlController fill:#fce4ec
    style EmailController fill:#fce4ec
