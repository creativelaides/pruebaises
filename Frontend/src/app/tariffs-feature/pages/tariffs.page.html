<section class="space-y-4">
  <div class="flex flex-wrap items-center justify-between gap-2">
    <h1 class="text-2xl font-bold">Tarifas</h1>
    <button class="btn btn-outline" (click)="reset()">Recargar</button>
  </div>

  @if (latest(); as item) {
    <div class="stats shadow w-full">
      <div class="stat">
        <div class="stat-title">Tarifa más reciente</div>
        <div class="stat-value text-primary">{{ item.totalCosts | copCurrency }}</div>
        <div class="stat-desc">{{ item.tariffOperator }} · {{ item.period }} {{ item.year }}</div>
      </div>
    </div>
  }

  <div class="card bg-base-100 shadow border border-base-300">
    <div class="card-body">
      <h2 class="card-title text-lg">Filtros opcionales</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3 items-end">
        <label class="form-control">
          <span class="label-text">Año</span>
          <input class="input input-bordered" type="text" [(ngModel)]="yearInput" placeholder="2025" />
        </label>
        <label class="form-control">
          <span class="label-text">Período</span>
          <input class="input input-bordered" type="text" list="period-options" [(ngModel)]="period" placeholder="Enero" />
        </label>
        <label class="form-control">
          <span class="label-text">Operador</span>
          <input class="input input-bordered" type="text" list="operator-options" [(ngModel)]="tariffOperator" placeholder="ENEL Bogotá - Cundinamarca" />
        </label>
        <label class="form-control">
          <span class="label-text">Nivel</span>
          <input class="input input-bordered" type="text" list="level-options" [(ngModel)]="level" placeholder="NIVEL II" />
        </label>
      </div>
      <datalist id="period-options">
        @for (option of periodOptions(); track option) {
          <option [value]="option"></option>
        }
      </datalist>
      <datalist id="operator-options">
        @for (option of operatorOptions(); track option) {
          <option [value]="option"></option>
        }
      </datalist>
      <datalist id="level-options">
        @for (option of levelOptions(); track option) {
          <option [value]="option"></option>
        }
      </datalist>
      <div class="mt-3 flex flex-wrap gap-2">
        <button class="btn btn-primary" (click)="searchByPeriod()">Consultar</button>
        <button class="btn btn-outline" (click)="reset()">Limpiar filtros</button>
      </div>
      @if (message()) { <div class="alert alert-warning mt-3">{{ message() }}</div> }
    </div>
  </div>

  <div class="overflow-x-auto border border-base-300 rounded-box bg-base-100">
    <table class="table table-zebra">
      <thead><tr><th>Año</th><th>Período</th><th>Operador</th><th>Nivel</th><th class="text-right">Total</th><th></th></tr></thead>
      <tbody>
        @if (loading()) {
          <tr><td colspan="6"><span class="loading loading-spinner loading-md"></span></td></tr>
        } @else {
          @for (item of pagedTariffs(); track item.id) {
            <tr>
              <td>{{ item.year }}</td>
              <td>{{ item.period }}</td>
              <td>{{ item.tariffOperator }}</td>
              <td>{{ item.level }}</td>
              <td class="text-right font-semibold">{{ item.totalCosts | copCurrency }}</td>
              <td><button class="btn btn-xs btn-outline" (click)="selectTariff(item.id)">Ver</button></td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>
  <div class="flex items-center justify-end gap-2">
    <button class="btn btn-sm" [disabled]="currentPage() <= 1" (click)="goToPreviousPage()">Anterior</button>
    <input class="input input-sm input-bordered w-20 text-center" type="number" min="1" [max]="totalPages()" [(ngModel)]="pageInput" />
    <button class="btn btn-sm btn-outline" (click)="goToPage()">Ir</button>
    <span class="text-sm opacity-80">Página {{ currentPage() }} de {{ totalPages() }}</span>
    <button class="btn btn-sm" [disabled]="currentPage() >= totalPages()" (click)="goToNextPage()">Siguiente</button>
  </div>

  @if (showDetailsModal() && selectedTariff(); as item) {
    <dialog class="modal modal-open">
      <div class="modal-box max-w-3xl">
        <h2 class="font-bold text-lg">Detalle de tarifa</h2>
        <div class="mt-3 grid sm:grid-cols-2 gap-3 text-sm">
          <div><span class="opacity-70">ID:</span> <span class="font-mono break-all">{{ item.id }}</span></div>
          <div><span class="opacity-70">Operador:</span> {{ item.tariffOperator }}</div>
          <div><span class="opacity-70">Período:</span> {{ item.period }} {{ item.year }}</div>
          <div><span class="opacity-70">Nivel:</span> {{ item.level }}</div>
          <div><span class="opacity-70">Compañía:</span> <span class="font-mono">{{ item.companyId }}</span></div>
          <div><span class="opacity-70">Total:</span> {{ item.totalCosts | copCurrency }}</div>
        </div>
        <div class="modal-action">
          <button class="btn btn-outline" (click)="closeDetails()">Cerrar</button>
          <button class="btn btn-primary" (click)="goToSimulation()">Llevar a simulación</button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button (click)="closeDetails()">close</button>
      </form>
    </dialog>
  }
</section>
